// å¯¼å…¥è·¯ç”±æ¨¡å—
import { router } from '@kit.ArkUI';
// å¯¼å…¥æ•°æ®æ¨¡åž‹
import { CityInfo, CityList } from '../model/WeatherModel';
// å¯¼å…¥å¤©æ°”æœåŠ¡
import { WeatherService } from '../common/WeatherService';

//=============== åŸŽå¸‚é€‰æ‹©é¡µé¢===============
@Entry
@Component
struct CitySelect {
  //===== çŠ¶æ€å˜é‡=====
  // æœç´¢å…³é”®è¯
  @State searchText: string = '';

  // æœç´¢ç»“æžœ
  @State searchResults: CityInfo[] = CityList;

  // çƒ­é—¨åŸŽå¸‚
  @State hotCities: string[] = [
    'åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·ž', 'æ·±åœ³',
    'æ­å·ž', 'å—äº¬', 'æ­¦æ±‰', 'æˆéƒ½'
  ];

  // åŽ†å²æœç´¢ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰
  @State historyList: string[] = ['åŒ—äº¬', 'ä¸Šæµ·'];

  //===== æœç´¢åŸŽå¸‚=====
  searchCity(keyword: string): void {
    this.searchResults = WeatherService.searchCity(keyword);
  }

  //===== é€‰æ‹©åŸŽå¸‚=====
  selectCity(cityName: string): void {
    // æ·»åŠ åˆ°åŽ†å²è®°å½•
    if (!this.historyList.includes(cityName)) {
      this.historyList.unshift(cityName);
      if (this.historyList.length > 5) {
        this.historyList.pop();
      }
    }

    // è¿”å›žä¸»é¡µå¹¶ä¼ é€’åŸŽå¸‚
    router.back({
      url: 'pages/Index',
      params: { city: cityName }
    });
  }

  //===== UIæž„å»º=====
  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        // è¿”å›žæŒ‰é’®
        Text('â†')
          .fontSize(28)
          .fontColor('#333333')
          .onClick(() => {
            router.back();
          })
          .padding(8)

        Text('é€‰æ‹©åŸŽå¸‚')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .margin({ left: 12 })

        Blank()
      }
      .width('100%')
      .height(56)
      .padding({ left: 12, right: 16 })
      .backgroundColor(Color.White)

      // æœç´¢æ¡†
      Row() {
        Text('ðŸ”')
          .fontSize(18)
          .fontColor('#999999')

        TextInput({
          placeholder: 'æœç´¢åŸŽå¸‚åç§°',
          text: this.searchText
        })
          .layoutWeight(1)
          .height(44)
          .backgroundColor('transparent')
          .placeholderColor('#999999')
          .onChange((value: string) => {
            this.searchText = value;
            this.searchCity(value);
          })

        // æ¸…é™¤æŒ‰é’®
        if (this.searchText.length > 0) {
          Text('âœ•')
            .fontSize(18)
            .fontColor('#999999')
            .onClick(() => {
              this.searchText = '';
              this.searchResults = CityList;
            })
        }
      }
      .width('92%')
      .height(48)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#f5f5f5')
      .borderRadius(24)
      .margin({ top: 12, bottom: 16 })

      // å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          // å¦‚æžœæ²¡æœ‰æœç´¢è¯ï¼Œæ˜¾ç¤ºçƒ­é—¨åŸŽå¸‚å’ŒåŽ†å²
          if (this.searchText.length === 0) {
            // åŽ†å²æœç´¢
            if (this.historyList.length > 0) {
              Column() {
                Row() {
                  Text('åŽ†å²æœç´¢')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#333333')
                  Blank()
                  Text('æ¸…ç©º')
                    .fontSize(14)
                    .fontColor('#999999')
                    .onClick(() => {
                      this.historyList = [];
                    })
                }
                .width('100%')
                .margin({ bottom: 12 })

                Flex({ wrap: FlexWrap.Wrap }) {
                  ForEach(this.historyList, (city: string) => {
                    Text(city)
                      .fontSize(14)
                      .fontColor('#666666')
                      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                      .backgroundColor('#f0f0f0')
                      .borderRadius(16)
                      .margin({ right: 10, bottom: 10 })
                      .onClick(() => {
                        this.selectCity(city);
                      })
                  })
                }
              }
              .width('100%')
              .padding(16)
              .backgroundColor(Color.White)
              .borderRadius(12)
              .margin({ bottom: 12 })
            }

            // çƒ­é—¨åŸŽå¸‚
            Column() {
              Text('çƒ­é—¨åŸŽå¸‚')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .width('100%')
                .margin({ bottom: 16 })

              Grid() {
                ForEach(this.hotCities, (city: string) => {
                  GridItem() {
                    Column() {
                      Text('ðŸ™ï¸')
                        .fontSize(28)
                      Text(city)
                        .fontSize(14)
                        .fontColor('#333333')
                        .margin({ top: 8 })
                    }
                    .width('100%')
                    .height('100%')
                    .justifyContent(FlexAlign.Center)
                    .backgroundColor('#f8f8f8')
                    .borderRadius(12)
                  }
                  .onClick(() => {
                    this.selectCity(city);
                  })
                })
              }
              .columnsTemplate('1fr 1fr 1fr 1fr')
              .rowsTemplate('1fr 1fr')
              .columnsGap(12)
              .rowsGap(12)
              .width('100%')
              .height(180)
            }
            .width('100%')
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .margin({ bottom: 12 })

            // å…¨éƒ¨åŸŽå¸‚åˆ—è¡¨
            Column() {
              Text('å…¨éƒ¨åŸŽå¸‚')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .width('100%')
                .margin({ bottom: 12 })

              ForEach(this.searchResults, (city: CityInfo) => {
                Row() {
                  Text('ðŸ“')
                    .fontSize(18)

                  Column() {
                    Text(city.name)
                      .fontSize(16)
                      .fontColor('#333333')
                    Text(city.province)
                      .fontSize(12)
                      .fontColor('#999999')
                      .margin({ top: 2 })
                  }
                  .alignItems(HorizontalAlign.Start)
                  .margin({ left: 12 })

                  Blank()

                  Text('â€º')
                    .fontSize(24)
                    .fontColor('#cccccc')
                }
                .width('100%')
                .height(64)
                .padding({ left: 12, right: 12 })
                .onClick(() => {
                  this.selectCity(city.name);
                })

                Divider()
                  .color('#f0f0f0')
                  .margin({ left: 44 })
              })
            }
            .width('100%')
            .padding({ top: 16, bottom: 16 })
            .backgroundColor(Color.White)
            .borderRadius(12)
          }
          // æ˜¾ç¤ºæœç´¢ç»“æžœ
          else {
            Column() {
              if (this.searchResults.length === 0) {
                // æ— ç»“æžœ
                Column() {
                  Text('ðŸ”')
                    .fontSize(60)
                  Text('æœªæ‰¾åˆ°ç›¸å…³åŸŽå¸‚')
                    .fontSize(16)
                    .fontColor('#999999')
                    .margin({ top: 16 })
                }
                .height(200)
                .justifyContent(FlexAlign.Center)
              } else {
                Text(`æ‰¾åˆ° ${this.searchResults.length} ä¸ªåŸŽå¸‚`)
                  .fontSize(14)
                  .fontColor('#999999')
                  .width('100%')
                  .margin({ bottom: 12 })

                ForEach(this.searchResults, (city: CityInfo) => {
                  Row() {
                    Text('ðŸ“')
                      .fontSize(18)

                    Column() {
                      // é«˜äº®æ˜¾ç¤ºåŒ¹é…çš„æ–‡å­—
                      Text(city.name)
                        .fontSize(16)
                        .fontColor('#333333')
                      Text(city.province)
                        .fontSize(12)
                        .fontColor('#999999')
                        .margin({ top: 2 })
                    }
                    .alignItems(HorizontalAlign.Start)
                    .margin({ left: 12 })

                    Blank()

                    Text('â€º')
                      .fontSize(24)
                      .fontColor('#cccccc')
                  }
                  .width('100%')
                  .height(64)
                  .padding({ left: 12, right: 12 })
                  .backgroundColor(Color.White)
                  .onClick(() => {
                    this.selectCity(city.name);
                  })

                  Divider()
                    .color('#f0f0f0')
                    .margin({ left: 44 })
                })
              }
            }
            .width('100%')
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(12)
          }
        }
        .padding({ left: 16, right: 16, bottom: 20 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f0f2f5')
  }
}