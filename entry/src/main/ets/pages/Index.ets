// å¯¼å…¥ç½‘ç»œè¯·æ±‚æ¨¡å—
import { http } from '@kit.NetworkKit';
// å¯¼å…¥è·¯ç”±æ¨¡å—
import { router } from '@kit.ArkUI';

// ==================== æ•°æ®æ¥å£å®šä¹‰ ====================
// å®šä¹‰å¤©æ°”æ•°æ®çš„ç±»å‹ç»“æ„
interface WeatherInfo {
  city: string;          // åŸå¸‚å
  temperature: string;   // æ¸©åº¦
  weather: string;       // å¤©æ°”çŠ¶å†µ
  humidity: string;      // æ¹¿åº¦
  wind: string;          // é£å‘é£åŠ›
  updateTime: string;    // æ›´æ–°æ—¶é—´
}

// å®šä¹‰APIè¿”å›çš„ç”Ÿæ´»æŒ‡æ•°æ•°æ®ç»“æ„
interface LiveIndex {
  name: string;          // æŒ‡æ•°åç§°
  level: string;         // ç­‰çº§
  desc: string;          // æè¿°
}

// ==================== ä¸»ç»„ä»¶ ====================
@Entry
@Component
struct Index {
  // ========== çŠ¶æ€å˜é‡å®šä¹‰ ==========
  // @State è£…é¥°å™¨ï¼šå½“å˜é‡å€¼æ”¹å˜æ—¶ï¼ŒUIä¼šè‡ªåŠ¨åˆ·æ–°

  // å½“å‰é€‰æ‹©çš„åŸå¸‚
  @State currentCity: string = 'åŒ—äº¬';

  // å¤©æ°”æ•°æ®å¯¹è±¡
  @State weatherData: WeatherInfo = {
    city: 'åŒ—äº¬',
    temperature: '--',
    weather: 'åŠ è½½ä¸­...',
    humidity: '--',
    wind: '--',
    updateTime: '--'
  };

  // æ˜¯å¦æ­£åœ¨åŠ è½½
  @State isLoading: boolean = false;

  // é”™è¯¯ä¿¡æ¯
  @State errorMessage: string = '';

  // ç”Ÿæ´»æŒ‡æ•°æ•°ç»„
  @State lifeIndexList: LiveIndex[] = [];

  // ========== ç”Ÿå‘½å‘¨æœŸå‡½æ•° ==========
  // é¡µé¢æ˜¾ç¤ºæ—¶è°ƒç”¨
  onPageShow(): void {
    // ä»è·¯ç”±å‚æ•°è·å–é€‰æ‹©çš„åŸå¸‚
    const params = router.getParams() as Record<string, string>;
    if (params && params['city']) {
      this.currentCity = params['city'];
    }
    // è·å–å¤©æ°”æ•°æ®
    this.getWeatherData();
  }

  // ========== ç½‘ç»œè¯·æ±‚æ–¹æ³• ==========
  // è·å–å¤©æ°”æ•°æ®
  getWeatherData(): void {
    // è®¾ç½®åŠ è½½çŠ¶æ€
    this.isLoading = true;
    this.errorMessage = '';

    // åˆ›å»ºHTTPè¯·æ±‚å¯¹è±¡
    const httpRequest = http.createHttp();

    // ä½¿ç”¨å…è´¹çš„å¤©æ°”APIï¼ˆè¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æ¼”ç¤ºï¼‰
    // çœŸå®é¡¹ç›®ä¸­æ›¿æ¢ä¸ºå®é™…çš„å¤©æ°”API
    const apiUrl = `https://restapi.amap.com/v3/weather/weatherInfo?city=${encodeURIComponent(this.currentCity)}&key=YOUR_API_KEY`;

    // ç”±äºAPIå¯èƒ½éœ€è¦ç”³è¯·keyï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨æ¨¡æ‹Ÿæ•°æ®
    // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚å»¶è¿Ÿ
    setTimeout(() => {
      this.simulateWeatherData();
    }, 1000);
  }

  // æ¨¡æ‹Ÿå¤©æ°”æ•°æ®ï¼ˆå®é™…é¡¹ç›®æ›¿æ¢ä¸ºçœŸå®APIè°ƒç”¨ï¼‰
  simulateWeatherData(): void {
    // æ¨¡æ‹Ÿä¸åŒåŸå¸‚çš„å¤©æ°”æ•°æ®
    const weatherMap: Record<string, WeatherInfo> = {
      'åŒ—äº¬': {
        city: 'åŒ—äº¬',
        temperature: '22',
        weather: 'æ™´',
        humidity: '45%',
        wind: 'åŒ—é£ 2çº§',
        updateTime: this.getCurrentTime()
      },
      'ä¸Šæµ·': {
        city: 'ä¸Šæµ·',
        temperature: '26',
        weather: 'å¤šäº‘',
        humidity: '65%',
        wind: 'ä¸œå—é£ 3çº§',
        updateTime: this.getCurrentTime()
      },
      'å¹¿å·': {
        city: 'å¹¿å·',
        temperature: '30',
        weather: 'é˜µé›¨',
        humidity: '80%',
        wind: 'å—é£ 2çº§',
        updateTime: this.getCurrentTime()
      },
      'æ·±åœ³': {
        city: 'æ·±åœ³',
        temperature: '29',
        weather: 'å¤šäº‘',
        humidity: '75%',
        wind: 'è¥¿å—é£ 2çº§',
        updateTime: this.getCurrentTime()
      },
      'æ­å·': {
        city: 'æ­å·',
        temperature: '24',
        weather: 'æ™´',
        humidity: '55%',
        wind: 'ä¸œé£ 1çº§',
        updateTime: this.getCurrentTime()
      }
    };

    // è·å–å¯¹åº”åŸå¸‚çš„å¤©æ°”ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
    if (weatherMap[this.currentCity]) {
      this.weatherData = weatherMap[this.currentCity];
    } else {
      this.weatherData = {
        city: this.currentCity,
        temperature: '25',
        weather: 'æ™´',
        humidity: '50%',
        wind: 'å¾®é£',
        updateTime: this.getCurrentTime()
      };
    }

    // è®¾ç½®ç”Ÿæ´»æŒ‡æ•°
    this.lifeIndexList = [
      { name: 'ç©¿è¡£æŒ‡æ•°', level: 'èˆ’é€‚', desc: 'å»ºè®®ç©¿è–„å¤–å¥—æˆ–è¡¬è¡«' },
      { name: 'ç´«å¤–çº¿', level: 'ä¸­ç­‰', desc: 'æ¶‚æ“¦SPFå¤§äº15çš„é˜²æ™’éœœ' },
      { name: 'è¿åŠ¨æŒ‡æ•°', level: 'é€‚å®œ', desc: 'å¤©æ°”è¾ƒå¥½ï¼Œé€‚åˆæˆ·å¤–è¿åŠ¨' },
      { name: 'æ´—è½¦æŒ‡æ•°', level: 'é€‚å®œ', desc: 'å¤©æ°”è¾ƒå¥½ï¼Œé€‚åˆæ´—è½¦' }
    ];

    // å…³é—­åŠ è½½çŠ¶æ€
    this.isLoading = false;
  }

  // è·å–å½“å‰æ—¶é—´å­—ç¬¦ä¸²
  getCurrentTime(): string {
    const now = new Date();
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
  }

  // æ ¹æ®å¤©æ°”è¿”å›å¯¹åº”çš„å›¾æ ‡ï¼ˆä½¿ç”¨æ–‡å­—ä»£æ›¿ï¼‰
  getWeatherIcon(weather: string): string {
    const iconMap: Record<string, string> = {
      'æ™´': 'â˜€ï¸',
      'å¤šäº‘': 'â›…',
      'é˜´': 'â˜ï¸',
      'é˜µé›¨': 'ğŸŒ§ï¸',
      'é›·é˜µé›¨': 'â›ˆï¸',
      'å°é›¨': 'ğŸŒ§ï¸',
      'ä¸­é›¨': 'ğŸŒ§ï¸',
      'å¤§é›¨': 'ğŸŒ§ï¸',
      'é›ª': 'â„ï¸',
      'é›¾': 'ğŸŒ«ï¸'
    };
    return iconMap[weather] || 'ğŸŒ¤ï¸';
  }

  // ========== UIæ„å»º ==========
  build() {
    // ä½¿ç”¨Navigationä½œä¸ºæ ¹å®¹å™¨
    Navigation() {
      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Column() {
        // ===== é¡¶éƒ¨åŸå¸‚é€‰æ‹©åŒºåŸŸ =====
        Row() {
          // åŸå¸‚åç§°ï¼Œç‚¹å‡»å¯åˆ‡æ¢åŸå¸‚
          Text(this.currentCity)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')

          // ä¸‹æ‹‰ç®­å¤´å›¾æ ‡
          Text(' â–¼')
            .fontSize(16)
            .fontColor('#666666')
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .padding(16)
        .onClick(() => {
          // ç‚¹å‡»è·³è½¬åˆ°åŸå¸‚é€‰æ‹©é¡µé¢
          router.pushUrl({
            url: 'pages/CitySelect'
          });
        })

        // ===== å¤©æ°”ä¸»ä¿¡æ¯å¡ç‰‡ =====
        Column() {
          // åŠ è½½ä¸­æ˜¾ç¤º
          if (this.isLoading) {
            // åŠ è½½åŠ¨ç”»
            LoadingProgress()
              .width(60)
              .height(60)
              .color('#1890ff')

            Text('åŠ è½½ä¸­...')
              .fontSize(16)
              .fontColor('#666666')
              .margin({ top: 16 })
          }
          // é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
          else if (this.errorMessage) {
            Text(this.errorMessage)
              .fontSize(16)
              .fontColor('#ff4d4f')

            // é‡è¯•æŒ‰é’®
            Button('é‡æ–°åŠ è½½')
              .margin({ top: 16 })
              .onClick(() => {
                this.getWeatherData();
              })
          }
          // æ­£å¸¸æ˜¾ç¤ºå¤©æ°”ä¿¡æ¯
          else {
            // å¤©æ°”å›¾æ ‡
            Text(this.getWeatherIcon(this.weatherData.weather))
              .fontSize(80)
              .margin({ bottom: 16 })

            // æ¸©åº¦æ˜¾ç¤º
            Row() {
              Text(this.weatherData.temperature)
                .fontSize(72)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333333')

              Text('Â°C')
                .fontSize(28)
                .fontColor('#666666')
                .margin({ top: 10 })
            }

            // å¤©æ°”çŠ¶å†µ
            Text(this.weatherData.weather)
              .fontSize(24)
              .fontColor('#666666')
              .margin({ top: 8 })

            // æ›´æ–°æ—¶é—´
            Text(`æ›´æ–°æ—¶é—´: ${this.weatherData.updateTime}`)
              .fontSize(12)
              .fontColor('#999999')
              .margin({ top: 16 })
          }
        }
        .width('90%')
        .padding(32)
        .backgroundColor('#ffffff')
        .borderRadius(16)
        .shadow({
          radius: 8,
          color: 'rgba(0, 0, 0, 0.1)',
          offsetX: 0,
          offsetY: 2
        })
        .margin({ top: 16 })

        // ===== å¤©æ°”è¯¦æƒ…å¡ç‰‡ =====
        if (!this.isLoading && !this.errorMessage) {
          Row() {
            // æ¹¿åº¦
            Column() {
              Text('ğŸ’§')
                .fontSize(24)
              Text('æ¹¿åº¦')
                .fontSize(12)
                .fontColor('#999999')
                .margin({ top: 4 })
              Text(this.weatherData.humidity)
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .margin({ top: 4 })
            }
            .layoutWeight(1)

            // åˆ†éš”çº¿
            Divider()
              .vertical(true)
              .height(50)
              .color('#eeeeee')

            // é£åŠ›
            Column() {
              Text('ğŸƒ')
                .fontSize(24)
              Text('é£åŠ›')
                .fontSize(12)
                .fontColor('#999999')
                .margin({ top: 4 })
              Text(this.weatherData.wind)
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .margin({ top: 4 })
            }
            .layoutWeight(1)
          }
          .width('90%')
          .padding(20)
          .backgroundColor('#ffffff')
          .borderRadius(16)
          .shadow({
            radius: 8,
            color: 'rgba(0, 0, 0, 0.1)',
            offsetX: 0,
            offsetY: 2
          })
          .margin({ top: 16 })

          // ===== ç”Ÿæ´»æŒ‡æ•°åŒºåŸŸ =====
          Column() {
            Text('ç”Ÿæ´»æŒ‡æ•°')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .width('100%')
              .textAlign(TextAlign.Start)
              .margin({ bottom: 12 })

            // ä½¿ç”¨Gridå¸ƒå±€æ˜¾ç¤ºç”Ÿæ´»æŒ‡æ•°
            Grid() {
              ForEach(this.lifeIndexList, (item: LiveIndex) => {
                GridItem() {
                  Column() {
                    Text(item.name)
                      .fontSize(14)
                      .fontColor('#666666')

                    Text(item.level)
                      .fontSize(16)
                      .fontWeight(FontWeight.Medium)
                      .fontColor('#1890ff')
                      .margin({ top: 4 })

                    Text(item.desc)
                      .fontSize(10)
                      .fontColor('#999999')
                      .margin({ top: 4 })
                      .maxLines(2)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                  }
                  .padding(12)
                  .width('100%')
                  .height('100%')
                  .backgroundColor('#f5f5f5')
                  .borderRadius(8)
                }
              })
            }
            .columnsTemplate('1fr 1fr')  // ä¸¤åˆ—å¸ƒå±€
            .rowsTemplate('1fr 1fr')      // ä¸¤è¡Œå¸ƒå±€
            .columnsGap(12)               // åˆ—é—´è·
            .rowsGap(12)                  // è¡Œé—´è·
            .width('100%')
            .height(180)
          }
          .width('90%')
          .padding(16)
          .backgroundColor('#ffffff')
          .borderRadius(16)
          .shadow({
            radius: 8,
            color: 'rgba(0, 0, 0, 0.1)',
            offsetX: 0,
            offsetY: 2
          })
          .margin({ top: 16, bottom: 16 })
        }

        // ===== åˆ·æ–°æŒ‰é’® =====
        Button('åˆ·æ–°å¤©æ°”')
          .width('90%')
          .height(48)
          .fontSize(16)
          .fontColor('#ffffff')
          .backgroundColor('#1890ff')
          .borderRadius(24)
          .margin({ top: 16 })
          .onClick(() => {
            this.getWeatherData();
          })
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#f0f2f5')
    }
    .title('å¤©æ°”é¢„æŠ¥')      // å¯¼èˆªæ æ ‡é¢˜
    .titleMode(NavigationTitleMode.Mini)  // å°æ ‡é¢˜æ¨¡å¼
    .hideBackButton(true)  // éšè—è¿”å›æŒ‰é’®ï¼ˆä¸»é¡µé¢ï¼‰
  }
}